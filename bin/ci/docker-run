#!/usr/bin/env bash
set -eu

DOCKER_ARGS=( )

if [[ -v CIRCLE_TEST_REPORTS ]]; then
  DOCKER_ARGS+=(--volume $CIRCLE_TEST_REPORTS:/test/artifacts)
fi

if [[ -f ~/cache/GeoLite2-Country.mmdb ]]; then
  DOCKER_ARGS+=(--volume ~/cache/GeoLite2-Country.mmdb:/app/GeoLite2-Country.mmdb)
fi

# Parse out known command flags to give to `docker run` instead of the command
while [ $# -ge 1 ]; do
  case $1 in
    --)
      shift
      break
      ;;
    -p)
      DOCKER_ARGS+=($1 $2)
      shift
      shift
      ;;
    *)
      break
      ;;
  esac
done

echo docker run \
  --net host \
  --env DJANGO_CONFIGURATION=Test \
  "${DOCKER_ARGS[@]}" \
  normandy:build \
  "$@"
